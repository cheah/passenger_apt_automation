<%
case distribution_class
when :ubuntu
  if is_distribution?("<= saucy")
    ruby_versions = ["1.8", "1.9.1"]
  elsif is_distribution?("<= trusty")
    ruby_versions = ["1.9.1", "2.0"]
  elsif is_distribution?("<= utopic")
    ruby_versions = ["2.0", "2.1"]
  else
    ruby_versions = ["2.1"]
  end
when :debian
  if is_distribution?("<= wheezy")
    ruby_versions = ["1.8", "1.9.1"]
  else
    ruby_versions = ["2.1"]
  end
else
  raise "Unknown distribution class"
end
-%>
#!/usr/bin/make -f
# export DH_VERBOSE=1

<% if ['1', 'true', 'on', 'yes'].include?(ENV['USE_CCACHE']) -%>
export USE_CCACHE=1
NGINX_CONFIGURE_OPTIONS = CC=/usr/lib/ccache/cc CXX=/usr/lib/ccache/c++
<% else -%>
NGINX_CONFIGURE_OPTIONS =
<% end -%>

# Speed up ccache (reduce I/O) by lightly compressing things.
# Always set these variables because pbuilder uses ccache transparently.
CCACHE_COMPRESS=1
export CCACHE_COMPRESS
CCACHE_COMPRESS_LEVEL=3
export CCACHE_COMPRESS_LEVEL

%:
	dh $@

override_dh_auto_configure:
	# Do nothing

override_dh_auto_build:
<% ruby_versions.each do |ruby_version| -%>
	/usr/bin/ruby<%= ruby_version %> /usr/bin/rake fakeroot
	mv pkg/fakeroot pkg/fakeroot<%= ruby_version %>
<% end -%>
	cd nginx-<%= PhusionPassenger::PREFERRED_NGINX_VERSION %> && \
		env $(NGINX_CONFIGURE_OPTIONS) ./configure --prefix=/tmp \
		<%= PhusionPassenger::STANDALONE_NGINX_CONFIGURE_OPTIONS %> \
		--add-module=`pwd`/../ext/nginx && \
		make && \
		mv objs/nginx objs/nginx-<%= PhusionPassenger::PREFERRED_NGINX_VERSION %>

override_dh_auto_install:
	mkdir debian/tmp/
	# Merge the files for all Ruby versions into a single directory.
<% ruby_versions.each do |ruby_version| -%>
	cp -a pkg/fakeroot<%= ruby_version %>/* debian/tmp/
<% end -%>
	./dev/install_scripts_bootstrap_code.rb --ruby /usr/lib/ruby/vendor_ruby debian/tmp/usr/bin/* debian/tmp/usr/sbin/*
	./dev/install_scripts_bootstrap_code.rb --nginx-module-config /usr/bin debian/tmp/usr/share/<%= PhusionPassenger::GLOBAL_NAMESPACE_DIRNAME %>/ngx_http_passenger_module/config
	touch debian/tmp/usr/share/<%= PhusionPassenger::GLOBAL_NAMESPACE_DIRNAME %>/release.txt

override_dh_auto_clean:
	/usr/bin/rake clean CLEAN_DOCS=false
<% ruby_versions.each do |ruby_version| -%>
	rm -rf pkg/fakeroot<%= ruby_version %>
<% end -%>
	cd nginx-<%= PhusionPassenger::PREFERRED_NGINX_VERSION %> && if test -f Makefile; then make clean; fi
	# Hack to prevent HTML files from being renegerated
	touch doc/*.html

# Because we include Ruby extensions, the Debian package depends on libruby.
# Since Phusion Passenger works fine without the Ruby extensions, we don't want
# to depend on libruby.
# https://github.com/phusion/passenger_apt_automation/issues/3
override_dh_shlibdeps:
	dh_shlibdeps
	sed -i -E 's/libruby.*?, //g' debian/*.substvars

override_dh_strip:
	dh_strip --dbg-package=passenger-dbg
